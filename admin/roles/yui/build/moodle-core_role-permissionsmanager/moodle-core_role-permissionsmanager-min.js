YUI.add("moodle-core_role-permissionsmanager",function(e,t){function r(){r.superclass.constructor.apply(this,arguments)}var n={ADDROLE:"a.allowlink, a.prohibitlink",REMOVEROLE:"a.preventlink, a.unprohibitlink",UNPROHIBIT:"a.unprohibitlink"};r.NAME=t,r.ATTRS={contextid:{setter:function(t){return/^\d+$/.test(t)||e.fail("Moodle permissions manager: Invalid context id specified"),t}},contextname:{validator:e.Lang.isString},adminurl:{validator:e.Lang.isString},overideableRoles:{value:null}},e.extend(r,e.Base,{panel:null,initializer:function(){this.container=e.one(e.config.doc.body),this.container.delegate("click",this.handleAddRole,n.ADDROLE,this),this.container.delegate("click",this.handleRemoveRole,n.REMOVEROLE,this)},handleAddRole:function(t){t.preventDefault(),this.once("overideableRolesLoaded",function(){var r=t.currentTarget.getData("action"),i=t.currentTarget.ancestor("tr.rolecap"),s={cap:i.getData("humanname"),context:this.get("contextname")},o=M.util.get_string("role"+r+"info","core_role",s);this.panel===null&&(this.panel=new M.core.dialogue({draggable:!0,modal:!0,closeButton:!0,width:"450px"})),this.panel.set("headerContent",M.util.get_string("role"+r+"header","core_role"));var u=e.Handlebars.compile('<div class="popup_content">{{CONFIRMATION}}<hr/><div class="role_buttons"/></div>'),a=e.Node.create(u({CONFIRMATION:o}));a.setStyle("text-align","center");var f=a.one(".role_buttons"),l,c,h=this.get("overideableRoles"),p=[];switch(r){case"allow":c=n.REMOVEROLE;break;case"prohibit":c=n.UNPROHIBIT}c&&i.all(c).each(function(e){p[e.getAttribute("data-role-id")]=!0},this);for(l in h){var d=e.Handlebars.compile('<input type="button" value="{{ROLENAME}}" data-role-id="{{ROLEID}}"/>'),v=e.Node.create(d({ROLENAME:h[l],ROLEID:l}));p[l]===!0&&v.setAttribute("disabled","disabled"),f.append(v)}a.delegate("click",function(e){var t=e.currentTarget.getData("role-id");this.changePermissions(this,i,t,r)},"input",this),this.panel.set("bodyContent",a),this.panel.show()},this),this._loadOverideableRoles()},handleRemoveRole:function(e){e.preventDefault(),this.once("overideableRolesLoaded",function(){var t=e.currentTarget.getData("action"),n=e.currentTarget.getData("role-id"),r=e.currentTarget.ancestor("tr.rolecap"),i={role:this.get("overideableRoles")[n],cap:r.getData("humanname"),context:this.get("contextname")},s={modal:!0,visible:!1,centered:!0,title:M.util.get_string("confirmunassigntitle","core_role"),question:M.util.get_string("confirmrole"+t,"core_role",i),yesLabel:M.util.get_string("confirmunassignyes","core_role"),noLabel:M.util.get_string("confirmunassignno","core_role")},o=new M.core.confirm(s);o.on("complete-yes",this.changePermissions,this,r,n,t)},this),this._loadOverideableRoles()},changePermissions:function(t,n,r,i){var s={contextid:this.get("contextid"),roleid:r,sesskey:M.cfg.sesskey,action:i,capability:n.getData("name")};e.io(this.get("adminurl")+"roles/ajax.php",{method:"POST",data:s,on:{complete:function(t,i){try{if(i.status!=200)new M.core.ajaxException(i);else{var s=e.JSON.parse(i.responseText),o=this.get("overideableRoles"),u=e.Handlebars.compile('<span>{{ROLE}} <a data-role-id="{{ROLEID}}"><img src="{{IMAGEURL}}" alt="" /></a></span>'),a=e.Node.create(u({ROLE:o[r],ROLEID:r,IMAGEURL:M.util.image_url("t/delete","moodle"),ACTION:s}));a.setStyle("display","inline-block");var f=a.one("a");f.setAttribute("href",this.get("adminurl")+"roles/permissions.php");switch(s){case"allow":a.setAttribute("class","allowed"),f.setAttribute("class","preventlink"),f.setData("action","prevent"),n.one(".allowmore").insert(a,"before"),this.panel.hide();break;case"prohibit":a.setAttribute("class","forbidden"),f.setAttribute("class","unprohibitlink"),f.setData("action","unprohibit"),n.one(".prohibitmore").insert(a,"before");var l=n.one(".allowedroles").one('a[data-role-id="'+r+'"]');l&&l.ancestor(".allowed").remove(),this.panel.hide();break;case"prevent":n.one('a[data-role-id="'+r+'"]').ancestor(".allowed").remove();break;case"unprohibit":n.one('a[data-role-id="'+r+'"]').ancestor(".forbidden").remove();break;default:}}}catch(c){new M.core.exception(c)}}},context:this})},_loadOverideableRoles:function(){var t={contextid:this.get("contextid"),getroles:1,sesskey:M.cfg.sesskey};e.io(this.get("adminurl")+"roles/ajax.php",{method:"POST",data:t,on:{complete:function(t,n){try{var r=e.JSON.parse(n.responseText);this.set("overideableRoles",r)}catch(i){new M.core.exception(i)}this._loadOverideableRoles=function(){this.fire("overideableRolesLoaded")},this._loadOverideableRoles()}},context:this})}}),e.namespace("M.core_role.permissionsmanager").Manager=r,e.namespace("M.core_role.permissionsmanager").instance=null,e.namespace("M.core_role.permissionsmanager").init=function(t){return e.M.core_role.permissionsmanager.instance=e.M.core_role.permissionsmanager.instance||new r(t),e.M.core_role.permissionsmanager.instance}},"@VERSION@",{requires:["base","node","io-base","json-parse","moodle-core-notification","handlebars"]});
